<?xml version="1.0" encoding="UTF-8"?>
<project default="buildFeature" name="build">
	<property name="build-featureAndPlugins" location="build/featureAndPlugins" />
	<property name="build-repository" location="../update" />
	<property name="repository-name" value="Google Dictionary For Eclipse Repository" />

	<property name="keystore" location="key/jeeeyul.keystore" />
	<property name="key-alias" value="Jeeeyul" />
	<property name="key-pass" value="jeeeyul" />
	<property name="category-file" location="category.xml" />

	<!-- 플러그인과 피쳐를 빌드합니다. 피쳐와 플러그인은 서명되지 않은 상태로 빌드 됩니다. 모든 빌드 작업전에 이 작업을 먼저 수행하고, 완료 될 때 까지 대기하십시오.-->
	<target name="buildFeature" depends="clean">
		<echo>피쳐 빌드 잡이 수행되는 중입니다...</echo>
		<echo>이 작업이 완료되면 ${build-featureAndPlugins}를 리프래시 하십시오.</echo>
		<pde.exportFeatures destination="${build-featureAndPlugins}" exportSource="false" exportType="directory" features="net.jeeeyul.eclipse.googledic.feature" useJARFormat="true" qualifier="${qualifier}" />
	</target>

	<target name="clean">
		<delete dir="${build-featureAndPlugins}" includes="**/*" includeemptydirs="true" />
		<delete dir="${build-repository}" includes="**/*.jar" includeemptydirs="true" />
		<eclipse.refreshLocal depth="infinite" resource="/" />
	</target>


	<!-- 현재 빌드된 피쳐와 플러그인을 이용하여 리포지터리를 갱신합니다. -->
	<target name="updateRepository">
		<eclipse.refreshLocal depth="infinite" resource="/" />

		<echo>기존의 리포지터리 삭제중.</echo>
		<delete dir="${build-repository}" includes="**/*.jar" />
		<mkdir dir="${build-repository}" />

		<echo>플러그인과 피쳐를 서명하는 중.</echo>
		<signjar jar="${build-featureAndPlugins}/features/*.jar" alias="${key-alias}" keystore="${keystore}" keypass="${key-pass}" storepass="${key-pass}" />
		<signjar jar="${build-featureAndPlugins}/plugins/*.jar" alias="${key-alias}" keystore="${keystore}" keypass="${key-pass}" storepass="${key-pass}" />

		<echo>${build-repository} 에 리포지터리를 구성하는 중.</echo>
		<eclipse.publish.featuresAndBundles metadatarepository="file:${build-repository}" artifactrepository="file:${build-repository}" metadatarepositoryname="${repository-name}" artifactrepositoryname="${repository-name}" compress="false" category="file:${category-file}">
			<features dir="${build-featureAndPlugins}/features" includes="*.jar" />
			<bundles dir="${build-featureAndPlugins}/plugins" includes="*.jar" />
		</eclipse.publish.featuresAndBundles>

		<echo>리포지터리 명칭 버그 수정하는 중.</echo>
		<replaceregexp file="${build-repository}/artifacts.xml" match="file:.+ - artifacts" replace="${repository-name}" encoding="utf-8" />
		<replaceregexp file="${build-repository}/content.xml" match="file:.+ - metadata" replace="${repository-name}" encoding="utf-8" />

		<echo>리포지터리 압축 및 서명 중.</echo>
		<jar destfile="${build-repository}/artifacts.jar">
			<fileset dir="${build-repository}" includes="artifacts.xml" />
		</jar>
		<jar destfile="${build-repository}/content.jar">
			<fileset dir="${build-repository}" includes="content.xml" />
		</jar>

		<delete dir="${build-repository}" includes="*.xml" />
		<signjar jar="${build-repository}/*.jar" alias="${key-alias}" keystore="${keystore}" keypass="${key-pass}" storepass="${key-pass}" />

		<eclipse.refreshLocal resource="/" depth="infinite" />
	</target>


	<target name="refreshKey">
		<delete dir="key" includes="*.keystore" />
		<exec dir="key" executable="keytool">
			<arg value="-genkeypair" />

			<arg value="-alias" />
			<arg value="${key-alias}" />

			<arg value="-keyalg" />
			<arg value="RSA" />

			<arg value="-keystore" />
			<arg value="${keystore}" />

			<arg value="-keysize" />
			<arg value="2048" />

			<arg value="-dname" />
			<arg value="CN=${key-alias}, OU=Personal, O=jeeeyul.net, L=Doksan, ST=Seoul, C=KR" />

			<arg value="-keypass" />
			<arg value="${key-pass}" />

			<arg value="-storepass" />
			<arg value="${key-pass}" />

			<arg value="-validity" />
			<arg value="365" />
		</exec>
	</target>


</project>
